
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>speechmatics.batch_client &#8212; speechmatics-python  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for speechmatics.batch_client</h1><div class="highlight"><pre>
<span></span><span class="c1"># (c) 2022, Cantab Research Ltd.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Wrapper library to interface with Speechmatics ASR batch v2 API.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">httpx</span>
<span class="kn">from</span> <span class="nn">polling2</span> <span class="kn">import</span> <span class="n">poll</span>
<span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">retry_if_exception_type</span><span class="p">,</span> <span class="n">stop_after_attempt</span>

<span class="kn">from</span> <span class="nn">speechmatics.exceptions</span> <span class="kn">import</span> <span class="n">JobNotFoundException</span><span class="p">,</span> <span class="n">TranscriptionError</span>
<span class="kn">from</span> <span class="nn">speechmatics.helpers</span> <span class="kn">import</span> <span class="n">get_version</span>
<span class="kn">from</span> <span class="nn">speechmatics.models</span> <span class="kn">import</span> <span class="n">BatchTranscriptionConfig</span><span class="p">,</span> <span class="n">ConnectionSettings</span><span class="p">,</span> <span class="n">UsageMode</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># If the logging level is set to DEBUG then websockets logs very verbosely,</span>
<span class="c1"># including a hex dump of every message being sent. Setting the websockets</span>
<span class="c1"># logger at INFO level specifically prevents this spam.</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;websockets.protocol&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">POLLING_DURATION</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># This is a reasonable default for when multiple audio files are submitted for</span>
<span class="c1"># transcription in one go, in submit_jobs.</span>
<span class="c1">#</span>
<span class="c1"># Customers are free to increase this to any kind of maximum they are</span>
<span class="c1"># comfortable with, but bear in mind there will be rate-limitting at the API</span>
<span class="c1"># end for over-use.</span>
<span class="n">CONCURRENCY_DEFAULT</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">CONCURRENCY_MAXIMUM</span> <span class="o">=</span> <span class="mi">50</span>


<span class="k">class</span> <span class="nc">_ForceMultipartDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a dictionary that evaluates to True, even if empty.</span>
<span class="sd">    Used in submit_job() to force proper multipart encoding when fetch_data is used.</span>
<span class="sd">    See https://github.com/encode/httpx/discussions/2399 (link to psf/requests#1081) for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="HttpClient"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.HttpClient">[docs]</a><span class="k">class</span> <span class="nc">HttpClient</span><span class="p">(</span><span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper class around httpx.Client that adds the sm-sdk query parameter to request urls&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_cli</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;from_cli&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_from_cli</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;from_cli&quot;</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;from_cli&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="HttpClient.build_request"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.HttpClient.build_request">[docs]</a>    <span class="k">def</span> <span class="nf">build_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="s2">&quot;-cli&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_cli</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">get_version</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">copy_merge_params</span><span class="p">({</span><span class="s2">&quot;sm-sdk&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;python</span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BatchClient"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient">[docs]</a><span class="k">class</span> <span class="nc">BatchClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Client class for Speechmatics Batch ASR REST API.</span>

<span class="sd">    This client may be used directly but must be closed afterwards, e.g.::</span>

<span class="sd">        client = BatchClient(auth_token)</span>
<span class="sd">        client.connect()</span>
<span class="sd">        list_of_jobs = client.list_jobs()</span>
<span class="sd">        client.close()</span>

<span class="sd">    It may also be used as a context manager, which handles opening and</span>
<span class="sd">    closing the connection for you, e.g.::</span>

<span class="sd">        with BatchClient(settings) as client:</span>
<span class="sd">            list_of_jobs = client.list_jobs()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">connection_settings_or_auth_token</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConnectionSettings</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">from_cli</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            connection_settings_or_auth_token (Union[str, ConnectionSettings, None], optional)</span>
<span class="sd">                If `str`,, assumes auth_token passed and default URL being used</span>
<span class="sd">                If `None`, attempts using auth_token from config.</span>
<span class="sd">                Defaults to `None`</span>
<span class="sd">            from_clie (bool)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection_settings_or_auth_token</span><span class="p">,</span> <span class="n">ConnectionSettings</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span> <span class="o">=</span> <span class="n">ConnectionSettings</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">UsageMode</span><span class="o">.</span><span class="n">Batch</span><span class="p">,</span> <span class="n">connection_settings_or_auth_token</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span> <span class="o">=</span> <span class="n">connection_settings_or_auth_token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">set_missing_values_from_config</span><span class="p">(</span><span class="n">UsageMode</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/v2&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;v2&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transcription_config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">auth_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept-Charset&quot;</span><span class="p">:</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_cli</span> <span class="o">=</span> <span class="n">from_cli</span>

<div class="viewcode-block" id="BatchClient.connect"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a connection to a Speechmatics Transcription REST endpoint&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="p">(</span>
            <span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span><span class="p">,</span>
            <span class="n">http2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_settings</span><span class="o">.</span><span class="n">ssl_context</span><span class="p">,</span>
            <span class="n">from_cli</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_cli</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="BatchClient.close"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up/close client connection pool.</span>

<span class="sd">        This is required when using the client directly, but not required when</span>
<span class="sd">        using the client as a context manager.</span>

<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="BatchClient.send_request"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.send_request">[docs]</a>    <span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a request using httpx.Client()</span>

<span class="sd">        :param method: HTTP request method</span>
<span class="sd">        :type method: str</span>

<span class="sd">        :param path: Configuration for the transcription.</span>
<span class="sd">        :type path: str</span>

<span class="sd">        :param **kwargs: Any valid kwarg of httpx.Client</span>

<span class="sd">        :returns: httpx Response object</span>
<span class="sd">        :rtype: httpx.Response</span>

<span class="sd">        :raises httpx.HTTPError: When a request fails, raises an HTTPError</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pylint: disable=no-member</span>
        <span class="nd">@retry</span><span class="p">(</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">(</span><span class="n">httpx</span><span class="o">.</span><span class="n">RemoteProtocolError</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">send</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="k">return</span> <span class="n">send</span><span class="p">()</span></div>

<div class="viewcode-block" id="BatchClient.list_jobs"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.list_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">list_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lists last 100 jobs within 7 days associated with auth_token for the SaaS</span>
<span class="sd">        or all of the jobs for the batch appliance.</span>

<span class="sd">        :returns: List of jobs</span>
<span class="sd">        :rtype: List[Dict[str, Any]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;jobs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="BatchClient.submit_job"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.submit_job">[docs]</a>    <span class="k">def</span> <span class="nf">submit_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">audio</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">transcription_config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">BatchTranscriptionConfig</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits audio and config for transcription.</span>

<span class="sd">        :param audio: Audio file path or tuple of filename and bytes, or None if using fetch_url</span>
<span class="sd">            NOTE: You must expliticly pass audio=None if providing a fetch_url in the config</span>
<span class="sd">        :type audio: os.Pathlike | str | Tuple[str, bytes] | None</span>

<span class="sd">        :param transcription_config: Configuration for the transcription.</span>
<span class="sd">        :type transcription_config:</span>
<span class="sd">            Dict[str, Any] | speechmatics.models.BatchTranscriptionConfig | str</span>

<span class="sd">        :returns: Job ID</span>
<span class="sd">        :rtype: str</span>

<span class="sd">        :raises httpx.HTTPError: For any request errors, httpx exceptions are raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Handle getting config into a dict</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transcription_config</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">transcription_config</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transcription_config</span><span class="p">,</span> <span class="n">BatchTranscriptionConfig</span><span class="p">):</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">transcription_config</span><span class="o">.</span><span class="n">as_config</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transcription_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">transcription_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Job configuration must be a BatchTranscriptionConfig object,</span>
<span class="sd">                a filepath as a string or Path object, or a dict&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If audio=None, fetch_data must be specified</span>
        <span class="n">file_object</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">audio</span> <span class="ow">and</span> <span class="s2">&quot;fetch_data&quot;</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only one of audio or fetch_data can be set at a time&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">audio</span> <span class="ow">and</span> <span class="s2">&quot;fetch_data&quot;</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="n">audio_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">audio</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
                <span class="c1"># httpx performance is better when using a file-like object</span>
                <span class="c1"># compared to passing the file contents as bytes.</span>
                <span class="n">file_object</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
                <span class="n">audio_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_object</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">file_object</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">audio</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;fetch_data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
                <span class="n">audio_data</span> <span class="o">=</span> <span class="n">audio</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Audio must be a filepath or a tuple of (filename, bytes)&quot;</span>
                <span class="p">)</span>

            <span class="c1"># httpx seems to expect an un-nested json, throws a type error otherwise.</span>
            <span class="n">config_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">config_dict</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>

            <span class="k">if</span> <span class="n">audio_data</span><span class="p">:</span>
                <span class="n">audio_file</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data_file&quot;</span><span class="p">:</span> <span class="n">audio_data</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">audio_file</span> <span class="o">=</span> <span class="n">_ForceMultipartDict</span><span class="p">()</span>

            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span>
                <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;jobs&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">config_data</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">audio_file</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_object</span><span class="p">:</span>
                <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">submit_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">audio_paths</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]],</span>
        <span class="n">transcription_config</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">concurrency</span><span class="o">=</span><span class="n">CONCURRENCY_DEFAULT</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">concurrency</span> <span class="o">&gt;</span> <span class="n">CONCURRENCY_MAXIMUM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;concurrency=</span><span class="si">{</span><span class="n">concurrency</span><span class="si">}</span><span class="s2"> is too high, choose a value &lt;= </span><span class="si">{</span><span class="n">CONCURRENCY_MAXIMUM</span><span class="si">}</span><span class="s2">!&quot;</span>
            <span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">wait</span><span class="p">():</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">pool</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">)[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">del</span> <span class="n">pool</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">job_id</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">POLLING_DURATION</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">audio_path</span> <span class="ow">in</span> <span class="n">audio_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">concurrency</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">wait</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">audio_path</span><span class="p">,</span> <span class="n">transcription_config</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> submitted as job </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">audio_path</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
                <span class="n">pool</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_path</span>
            <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> submit failed with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">audio_path</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">wait</span><span class="p">()</span>

<div class="viewcode-block" id="BatchClient.get_job_result"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.get_job_result">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">transcription_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;json-v2&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request results of a transcription job.</span>

<span class="sd">        :param job_id: ID of previously submitted job.</span>
<span class="sd">        :type job_id: str</span>

<span class="sd">        :param transcription_format: Format of transcript. Defaults to json.</span>
<span class="sd">            Valid options are json-v2, txt, srt. json is accepted as an</span>
<span class="sd">            alias for json-v2.</span>
<span class="sd">        :type format: str</span>

<span class="sd">        :returns: False if job is still running or does not exist, or</span>
<span class="sd">            transcription in requested format</span>
<span class="sd">        :rtype: bool | str | Dict[str, Any]</span>

<span class="sd">        :raises JobNotFoundException : When a job_id is not found.</span>
<span class="sd">        :raises httpx.HTTPError: For any request other than 404, httpx exceptions are raised.</span>
<span class="sd">        :raises TranscriptionError: When the transcription format is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transcription_format</span> <span class="o">=</span> <span class="n">transcription_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">transcription_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;json-v2&quot;</span><span class="p">,</span> <span class="s2">&quot;json_v2&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="s2">&quot;srt&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">TranscriptionError</span><span class="p">(</span>
                <span class="s1">&#39;Invalid transcription format. Valid formats are : &quot;json-v2&quot;,&#39;</span>
                <span class="s1">&#39;&quot;json_v2&quot;, &quot;json&quot;, &quot;txt&quot;, &quot;srt &quot;&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">transcription_format</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;json-v2&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;json_v2&quot;</span><span class="p">]:</span>
            <span class="n">transcription_format</span> <span class="o">=</span> <span class="s2">&quot;json-v2&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span>
                <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;jobs&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;transcript&quot;</span><span class="p">]),</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="n">transcription_format</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobNotFoundException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
            <span class="k">raise</span> <span class="n">exc</span>

        <span class="k">if</span> <span class="n">transcription_format</span> <span class="o">==</span> <span class="s2">&quot;json-v2&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span></div>

<div class="viewcode-block" id="BatchClient.delete_job"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.delete_job">[docs]</a>    <span class="k">def</span> <span class="nf">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a job. Must pass force=True to cancel a running job.</span>

<span class="sd">        :param job_id: ID of previously submitted job.</span>
<span class="sd">        :type job_id: str</span>

<span class="sd">        :param force: When set, a running job will be force terminated. When</span>
<span class="sd">            unset (default), a running job will not be terminated and we will</span>
<span class="sd">            return False.</span>
<span class="sd">        :type format: bool</span>

<span class="sd">        :return: Deletion status</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span>
                <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;jobs&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">]),</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;force&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">force</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()},</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> deleted&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;deleted&quot;</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> was not deleted. Error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobNotFoundException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
            <span class="k">raise</span> <span class="n">exc</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BatchClient.check_job_status"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.check_job_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the status of a job.</span>

<span class="sd">        :param job_id: ID of previously submitted job.</span>
<span class="sd">        :type job_id: str</span>

<span class="sd">        :return: Job status</span>
<span class="sd">        :rtype: Dict[str, Any]</span>

<span class="sd">        :raises JobNotFoundException: When a job_id is not found.</span>
<span class="sd">        :raises httpx.HTTPError: For any request other than 404, httpx exceptions are raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;jobs&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">]))</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobNotFoundException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">error</span>
            <span class="k">raise</span> <span class="n">error</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>

<div class="viewcode-block" id="BatchClient.wait_for_completion"><a class="viewcode-back" href="../../batch_client.html#speechmatics.batch_client.BatchClient.wait_for_completion">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_completion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transcription_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;txt&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Blocks until job is complete, returning a transcript in</span>
<span class="sd">        the requested format.</span>

<span class="sd">        :param job_id: ID of previously submitted job.</span>
<span class="sd">        :type job_id: str</span>

<span class="sd">        :param transcription_format: Format of transcript. Defaults to txt.</span>
<span class="sd">            Valid options are json-v2, txt, srt. json is accepted as an</span>
<span class="sd">            alias for json-v2.</span>
<span class="sd">        :type format: str</span>

<span class="sd">        :return: Transcription in requested format</span>
<span class="sd">        :rtype: Union[str, Dict[str, Any]]</span>

<span class="sd">        :raises JobNotFoundException : When a job_id is not found.</span>
<span class="sd">        :raises httpx.HTTPError: For any request other than 404, httpx exceptions are raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_poll_for_status</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">job_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">)[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">job_status</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">job_status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Job ID </span><span class="si">%s</span><span class="s2"> still running, polling again in </span><span class="si">%s</span><span class="s2"> seconds.&quot;</span><span class="p">,</span>
                    <span class="n">job_id</span><span class="p">,</span>
                    <span class="n">POLLING_DURATION</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="n">TranscriptionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> status </span><span class="si">{</span><span class="n">job_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job_result</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">transcription_format</span><span class="p">)</span>

        <span class="n">min_rtf</span> <span class="o">=</span> <span class="mf">0.10</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">][</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Waiting </span><span class="si">%i</span><span class="s2"> sec to begin polling for completion.&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">min_rtf</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Wait until the min. processing time has passed before polling.</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">min_rtf</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting poll.&quot;</span><span class="p">)</span>
        <span class="n">poll</span><span class="p">(</span><span class="n">_poll_for_status</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">POLLING_DURATION</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job_result</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">transcription_format</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Python API client and CLI for Speechmatics</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=speechmatics&repo=speechmatics-python&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../client.html">speechmatics.client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../batch_client.html">speechmatics.batch_client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exceptions.html">speechmatics.exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../helpers.html">speechmatics.helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">speechmatics.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../constants.html">speechmatics.client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli_parser.html">Speechmatics CLI Tool</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Cantab Research Ltd..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>